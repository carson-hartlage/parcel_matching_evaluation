---
title: "parcel_matching_evaluation"
author: "Carson Hartlage"
date: "`r Sys.Date()`"
output:
  html_document:
        toc: true
        toc_float:
            collapsed: false
            smooth_scroll: true
        code_download: true
        code_folding: hide
        highlight: pygments
        df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(addr)
library(units)
library(dplyr)
library(purrr)
library(sf)
library(ggplot2)
```

## Load in & prepare data

```{r}
d <- readRDS("~/Documents/GitHub/parcel_matching_evaluation/NAD_matching_data_10.13.25.rds")

# d <- qs::qread("~/Documents/GitHub/parcel_matching_methods_evaluation/data/geomatched_NAD_to_parcels.qs")
# d <- d |>
#   mutate(
#     addr_matched_parcel_id = map_chr(
#       cagis_addr_data,
#       ~ if (is.null(.x) || nrow(.x) == 0) {
#         NA_character_
#       } else {
#         sample(.x$cagis_parcel_id, 1)
#       }
#     )
#   )

frank <- filter(d, county == "Franklin")
ham <- filter(d, county == "Hamilton")
```

## Match & agreement rates
### No distance threshold
```{r}
agreement_equal <- function(col1, col2) {
  both_na <- is.na(col1) & is.na(col2)
  both_non_na <- !is.na(col1) & !is.na(col2)
  equal_vals <- both_non_na & (col1 == col2)
  sum(both_na | equal_vals)
}

agreement_threshold <- function(col1, col2, tol = 0.2) {
  both_na <- is.na(col1) & is.na(col2)
  both_non_na <- !is.na(col1) & !is.na(col2)
  equal_vals <- both_non_na & (col1 >= col2 * (1 - tol)) & (col1 <= col2 * (1 + tol))
  sum(both_na | equal_vals)
}
```

```{r, echo=FALSE}
rates <- data.frame(
  county = c(rep("Hamilton", 3), rep("Franklin", 3)),
  method = rep(c("addr", "NAD_geo", "DeGAUSS_geo"), 2),

  match_rate = c(
    sum(!is.na(ham$addr_matched_parcel_id)) / nrow(ham),
    sum(!is.na(ham$nad_closest_parcel_id)) / nrow(ham),
    sum(!is.na(ham$degauss_closest_parcel_id)) / nrow(ham),
    sum(!is.na(frank$addr_matched_parcel_id)) / nrow(frank),
    sum(!is.na(frank$nad_closest_parcel_id)) / nrow(frank),
    sum(!is.na(frank$degauss_closest_parcel_id)) / nrow(frank)
  ),

  parcel_id_agree_with_addr = c(
    1,
    agreement_equal(ham$nad_closest_parcel_id, ham$addr_matched_parcel_id) / nrow(ham),
    agreement_equal(ham$degauss_closest_parcel_id, ham$addr_matched_parcel_id) / nrow(ham),
    1,
    agreement_equal(frank$nad_closest_parcel_id, frank$addr_matched_parcel_id) / nrow(frank),
    agreement_equal(frank$degauss_closest_parcel_id, frank$addr_matched_parcel_id) / nrow(frank)
  ),

  land_use_agree_with_addr = c(
    1,
    agreement_equal(ham$nad_closest_parcel_land_use, ham$addr_matched_parcel_land_use) / nrow(ham),
    agreement_equal(ham$degauss_closest_parcel_land_use, ham$addr_matched_parcel_land_use) / nrow(ham),
    1,
    agreement_equal(frank$nad_closest_parcel_land_use, frank$addr_matched_parcel_land_use) / nrow(frank),
    agreement_equal(frank$degauss_closest_parcel_land_use, frank$addr_matched_parcel_land_use) / nrow(frank)
  ),

value_20_agree_with_addr = c(
  1,
  agreement_threshold(ham$nad_closest_parcel_value, ham$addr_matched_parcel_value) / nrow(ham),
  agreement_threshold(ham$degauss_closest_parcel_value, ham$addr_matched_parcel_value) / nrow(ham),
  1,
  agreement_threshold(frank$nad_closest_parcel_value, frank$addr_matched_parcel_value) / nrow(frank),
  agreement_threshold(frank$degauss_closest_parcel_value, frank$addr_matched_parcel_value) / nrow(frank)
  )
)

# rates_long <- rates |>
#   tidyr::pivot_longer(
#     cols = c(match_rate, parcel_id_agree_with_addr, land_use_agree_with_addr, value_20_agree_with_addr),
#     names_to = "metric",
#     values_to = "value"
#   )

knitr::kable(rates)
```

### 100m
```{r}
threshold_ft <- 328.08333333

library(dplyr)

ham <- ham |>
  mutate(
    across(c(nad_dist_to_closest_parcel, degauss_dist_to_closest_parcel), as.numeric),
    
    nad_closest_parcel_id = if_else(nad_dist_to_closest_parcel <= threshold_ft, nad_closest_parcel_id, NA_character_),
    degauss_closest_parcel_id = if_else(degauss_dist_to_closest_parcel <= threshold_ft, degauss_closest_parcel_id, NA_character_),
    
    across(c(nad_closest_parcel_land_use, nad_closest_parcel_value),
           ~ if_else(is.na(nad_closest_parcel_id), NA, .x)),
    across(c(degauss_closest_parcel_land_use, degauss_closest_parcel_value),
           ~ if_else(is.na(degauss_closest_parcel_id), NA, .x))
  )


frank <- frank |>
  mutate(
    across(c(nad_dist_to_closest_parcel, degauss_dist_to_closest_parcel), as.numeric),
    
    nad_closest_parcel_id = if_else(nad_dist_to_closest_parcel <= threshold_ft, nad_closest_parcel_id, NA_character_),
    degauss_closest_parcel_id = if_else(degauss_dist_to_closest_parcel <= threshold_ft, degauss_closest_parcel_id, NA_character_),
    
    across(c(nad_closest_parcel_land_use, nad_closest_parcel_value),
           ~ if_else(is.na(nad_closest_parcel_id), NA, .x)),
    across(c(degauss_closest_parcel_land_use, degauss_closest_parcel_value),
           ~ if_else(is.na(degauss_closest_parcel_id), NA, .x))
  )

rates <- data.frame(
  county = c(rep("Hamilton", 3), rep("Franklin", 3)),
  method = rep(c("addr", "NAD_geo", "DeGAUSS_geo"), 2),

  match_rate = c(
    sum(!is.na(ham$addr_matched_parcel_id)) / nrow(ham),
    sum(!is.na(ham$nad_closest_parcel_id)) / nrow(ham),
    sum(!is.na(ham$degauss_closest_parcel_id)) / nrow(ham),
    sum(!is.na(frank$addr_matched_parcel_id)) / nrow(frank),
    sum(!is.na(frank$nad_closest_parcel_id)) / nrow(frank),
    sum(!is.na(frank$degauss_closest_parcel_id)) / nrow(frank)
  ),

  parcel_id_agree_with_addr = c(
    1,
    agreement_equal(ham$nad_closest_parcel_id, ham$addr_matched_parcel_id) / nrow(ham),
    agreement_equal(ham$degauss_closest_parcel_id, ham$addr_matched_parcel_id) / nrow(ham),
    1,
    agreement_equal(frank$nad_closest_parcel_id, frank$addr_matched_parcel_id) / nrow(frank),
    agreement_equal(frank$degauss_closest_parcel_id, frank$addr_matched_parcel_id) / nrow(frank)
  ),

  land_use_agree_with_addr = c(
    1,
    agreement_equal(ham$nad_closest_parcel_land_use, ham$addr_matched_parcel_land_use) / nrow(ham),
    agreement_equal(ham$degauss_closest_parcel_land_use, ham$addr_matched_parcel_land_use) / nrow(ham),
    1,
    agreement_equal(frank$nad_closest_parcel_land_use, frank$addr_matched_parcel_land_use) / nrow(frank),
    agreement_equal(frank$degauss_closest_parcel_land_use, frank$addr_matched_parcel_land_use) / nrow(frank)
  ),

value_20_agree_with_addr = c(
  1,
  agreement_threshold(ham$nad_closest_parcel_value, ham$addr_matched_parcel_value) / nrow(ham),
  agreement_threshold(ham$degauss_closest_parcel_value, ham$addr_matched_parcel_value) / nrow(ham),
  1,
  agreement_threshold(frank$nad_closest_parcel_value, frank$addr_matched_parcel_value) / nrow(frank),
  agreement_threshold(frank$degauss_closest_parcel_value, frank$addr_matched_parcel_value) / nrow(frank)
  )
)

rates_long <- rates |>
  tidyr::pivot_longer(
    cols = c(match_rate, parcel_id_agree_with_addr, land_use_agree_with_addr, value_20_agree_with_addr),
    names_to = "metric",
    values_to = "value"
  )

knitr::kable(rates)
```

### 50m
```{r}
threshold_ft <- 164.04166667

ham <- ham |>
  mutate(
    across(c(nad_dist_to_closest_parcel, degauss_dist_to_closest_parcel), as.numeric),
    
    nad_closest_parcel_id = if_else(nad_dist_to_closest_parcel <= threshold_ft, nad_closest_parcel_id, NA_character_),
    degauss_closest_parcel_id = if_else(degauss_dist_to_closest_parcel <= threshold_ft, degauss_closest_parcel_id, NA_character_),
    
    across(c(nad_closest_parcel_land_use, nad_closest_parcel_value),
           ~ if_else(is.na(nad_closest_parcel_id), NA, .x)),
    across(c(degauss_closest_parcel_land_use, degauss_closest_parcel_value),
           ~ if_else(is.na(degauss_closest_parcel_id), NA, .x))
  )

frank <- frank |>
  mutate(
    across(c(nad_dist_to_closest_parcel, degauss_dist_to_closest_parcel), as.numeric),
    
    nad_closest_parcel_id = if_else(nad_dist_to_closest_parcel <= threshold_ft, nad_closest_parcel_id, NA_character_),
    degauss_closest_parcel_id = if_else(degauss_dist_to_closest_parcel <= threshold_ft, degauss_closest_parcel_id, NA_character_),
    
    across(c(nad_closest_parcel_land_use, nad_closest_parcel_value),
           ~ if_else(is.na(nad_closest_parcel_id), NA, .x)),
    across(c(degauss_closest_parcel_land_use, degauss_closest_parcel_value),
           ~ if_else(is.na(degauss_closest_parcel_id), NA, .x))
  )

rates <- data.frame(
  county = c(rep("Hamilton", 3), rep("Franklin", 3)),
  method = rep(c("addr", "NAD_geo", "DeGAUSS_geo"), 2),

  match_rate = c(
    sum(!is.na(ham$addr_matched_parcel_id)) / nrow(ham),
    sum(!is.na(ham$nad_closest_parcel_id)) / nrow(ham),
    sum(!is.na(ham$degauss_closest_parcel_id)) / nrow(ham),
    sum(!is.na(frank$addr_matched_parcel_id)) / nrow(frank),
    sum(!is.na(frank$nad_closest_parcel_id)) / nrow(frank),
    sum(!is.na(frank$degauss_closest_parcel_id)) / nrow(frank)
  ),

  parcel_id_agree_with_addr = c(
    1,
    agreement_equal(ham$nad_closest_parcel_id, ham$addr_matched_parcel_id) / nrow(ham),
    agreement_equal(ham$degauss_closest_parcel_id, ham$addr_matched_parcel_id) / nrow(ham),
    1,
    agreement_equal(frank$nad_closest_parcel_id, frank$addr_matched_parcel_id) / nrow(frank),
    agreement_equal(frank$degauss_closest_parcel_id, frank$addr_matched_parcel_id) / nrow(frank)
  ),

  land_use_agree_with_addr = c(
    1,
    agreement_equal(ham$nad_closest_parcel_land_use, ham$addr_matched_parcel_land_use) / nrow(ham),
    agreement_equal(ham$degauss_closest_parcel_land_use, ham$addr_matched_parcel_land_use) / nrow(ham),
    1,
    agreement_equal(frank$nad_closest_parcel_land_use, frank$addr_matched_parcel_land_use) / nrow(frank),
    agreement_equal(frank$degauss_closest_parcel_land_use, frank$addr_matched_parcel_land_use) / nrow(frank)
  ),

value_20_agree_with_addr = c(
  1,
  agreement_threshold(ham$nad_closest_parcel_value, ham$addr_matched_parcel_value) / nrow(ham),
  agreement_threshold(ham$degauss_closest_parcel_value, ham$addr_matched_parcel_value) / nrow(ham),
  1,
  agreement_threshold(frank$nad_closest_parcel_value, frank$addr_matched_parcel_value) / nrow(frank),
  agreement_threshold(frank$degauss_closest_parcel_value, frank$addr_matched_parcel_value) / nrow(frank)
  )
)

knitr::kable(rates)
```

```{r}
# rate of addr multi-matches
# sum(map_int(ham$cagis_addr_data, ~ if (is.null(.) || length(.) == 0) 0 else nrow(.)) > 1)/nrow(ham)
# sum(map_int(frank$cagis_addr_data, ~ if (is.null(.) || length(.) == 0) 0 else nrow(.)) > 1)/nrow(frank)

```
## Land use agreement matrices
### No distance threshold
```{r}
df <- ham %>%
  mutate(
    col1 = forcats::fct_explicit_na(factor(addr_matched_parcel_land_use), na_level = "NA"),
    col2 = forcats::fct_explicit_na(factor(nad_closest_parcel_land_use), na_level = "NA")
  )

levels_order <- sort(unique(c(levels(df$col1), levels(df$col2))))
df <- df %>%
  mutate(
    col1 = factor(col1, levels = levels_order),
    col2 = factor(col2, levels = levels_order)
  )

agreement_table <- table(df$col1, df$col2)
agreement_df <- as.data.frame(agreement_table)
colnames(agreement_df) <- c("col1", "col2", "count")

ggplot(agreement_df, aes(x = col1, y = col2, fill = count)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(option = "viridis", trans = "log1p") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
  ) +
  labs(title = "Land Use Agreement Matrix Heatmap, Hamilton, NAD",
       x = "addr",
       y = "NAD",
       fill = "Count")
```

```{r}
df <- ham %>%
  mutate(
    col1 = forcats::fct_explicit_na(factor(addr_matched_parcel_land_use), na_level = "NA"),
    col2 = forcats::fct_explicit_na(factor(degauss_closest_parcel_land_use), na_level = "NA")
  )

levels_order <- sort(unique(c(levels(df$col1), levels(df$col2))))
df <- df %>%
  mutate(
    col1 = factor(col1, levels = levels_order),
    col2 = factor(col2, levels = levels_order)
  )

agreement_table <- table(df$col1, df$col2)
agreement_df <- as.data.frame(agreement_table)
colnames(agreement_df) <- c("col1", "col2", "count")

ggplot(agreement_df, aes(x = col1, y = col2, fill = count)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(option = "viridis", trans = "log1p") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
  ) +
  labs(title = "Land Use Agreement Matrix Heatmap, Hamilton, DeGAUSS",
       x = "addr",
       y = "DeGAUSS",
       fill = "Count")
```

```{r}
df <- frank %>%
  mutate(
    col1 = forcats::fct_explicit_na(factor(addr_matched_parcel_land_use), na_level = "NA"),
    col2 = forcats::fct_explicit_na(factor(nad_closest_parcel_land_use), na_level = "NA")
  )

levels_order <- sort(unique(c(levels(df$col1), levels(df$col2))))
df <- df %>%
  mutate(
    col1 = factor(col1, levels = levels_order),
    col2 = factor(col2, levels = levels_order)
  )

agreement_table <- table(df$col1, df$col2)
agreement_df <- as.data.frame(agreement_table)
colnames(agreement_df) <- c("col1", "col2", "count")

ggplot(agreement_df, aes(x = col1, y = col2, fill = count)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(option = "viridis", trans = "log1p") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
  ) +
  labs(title = "Land Use Agreement Matrix Heatmap, Franklin, NAD",
       x = "addr",
       y = "NAD",
       fill = "Count")
```

```{r}
df <- frank %>%
  mutate(
    col1 = forcats::fct_explicit_na(factor(addr_matched_parcel_land_use), na_level = "NA"),
    col2 = forcats::fct_explicit_na(factor(degauss_closest_parcel_land_use), na_level = "NA")
  )

levels_order <- sort(unique(c(levels(df$col1), levels(df$col2))))
df <- df %>%
  mutate(
    col1 = factor(col1, levels = levels_order),
    col2 = factor(col2, levels = levels_order)
  )

agreement_table <- table(df$col1, df$col2)
agreement_df <- as.data.frame(agreement_table)
colnames(agreement_df) <- c("col1", "col2", "count")

ggplot(agreement_df, aes(x = col1, y = col2, fill = count)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(option = "viridis", trans = "log1p") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
  ) +
  labs(title = "Land Use Agreement Matrix Heatmap, Franklin, DeGAUSS",
       x = "addr",
       y = "DeGAUSS",
       fill = "Count")
```
